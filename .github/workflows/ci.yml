name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: rustup component add rustfmt
      - run: cargo fmt --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: rustup component add clippy
      - run: cargo clippy -- -D warnings

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: cargo build

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: cargo test

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: cargo build --release
      - name: Start server
        run: |
          cargo run --release &
          sleep 2
      - run: pip install -r py_tests/requirements.txt
      - run: pytest py_tests/redis_test.py -v

  benchmark:
    name: Benchmark
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Install redis-tools
        run: sudo apt-get update && sudo apt-get install -y redis-tools
      - run: cargo build --release
      - name: Start server
        run: |
          cargo run --release &
          sleep 2
      - name: Run benchmark
        run: |
          redis-benchmark -h 127.0.0.1 -p 6379 \
            -t ping,set,get,lpush,sadd,zadd \
            -c 50 -n 100000 --csv \
            > benchmark.csv
      - name: Generate HTML report
        run: |
          cat > benchmark.html <<'HTMLEOF'
          <!DOCTYPE html>
          <html><head><title>Redis Benchmark</title>
          <style>
            body { font-family: system-ui, sans-serif; max-width: 800px; margin: 40px auto; padding: 0 20px; }
            table { border-collapse: collapse; width: 100%; }
            th, td { border: 1px solid #ddd; padding: 8px 12px; text-align: right; }
            th { background: #f5f5f5; text-align: left; }
            tr:nth-child(even) { background: #fafafa; }
            h1 { color: #333; }
            .meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
          </style></head><body>
          <h1>Benchmark Results</h1>
          <div class="meta">Generated: TIMESTAMP</div>
          <table><thead><tr><th>Command</th><th>Requests/sec</th><th>p50 (ms)</th><th>p95 (ms)</th><th>p99 (ms)</th></tr></thead>
          <tbody>
          HTMLEOF

          # Parse CSV (skip header) and build table rows
          tail -n +2 benchmark.csv | while IFS=',' read -r test rps avg_latency p50 p95 p99 rest; do
            test=$(echo "$test" | tr -d '"')
            p50=$(echo "$p50" | tr -d '"')
            p95=$(echo "$p95" | tr -d '"')
            p99=$(echo "$p99" | tr -d '"')
            rps=$(echo "$rps" | tr -d '"')
            echo "<tr><td style='text-align:left'>$test</td><td>$rps</td><td>$p50</td><td>$p95</td><td>$p99</td></tr>" >> benchmark.html
          done

          cat >> benchmark.html <<'HTMLEOF'
          </tbody></table></body></html>
          HTMLEOF

          # Stamp the date
          sed -i "s/TIMESTAMP/$(date -u '+%Y-%m-%d %H:%M:%S UTC')/" benchmark.html
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            benchmark.csv
            benchmark.html
